name: Update CLAUDE.md Documentation

on:
  push:
    branches: [ main, master ]
    paths:
      - 'sql_analyzer.py'
      - 'Analyze-SqlCode.ps1'
      - 'config.json'
      - 'requirements.txt'
      - 'README.md'
      - 'sql/**'
      - 'examples/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'sql_analyzer.py'
      - 'Analyze-SqlCode.ps1'
      - 'config.json'
      - 'requirements.txt'
      - 'README.md'
      - 'sql/**'
      - 'examples/**'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update CLAUDE.md even if no changes detected'
        required: false
        default: 'false'
        type: boolean

env:
  CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}

jobs:
  update-claude-md:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install anthropic requests pyyaml

    - name: Analyze codebase changes
      id: analyze
      run: |
        python scripts/analyze_codebase_changes.py > changes_summary.txt
        echo "changes_detected=$([ -s changes_summary.txt ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

    - name: Generate updated CLAUDE.md
      if: steps.analyze.outputs.changes_detected == 'true' || github.event.inputs.force_update == 'true'
      run: |
        python scripts/generate_claude_md.py \
          --input-dir . \
          --output CLAUDE.md.new \
          --changes-summary changes_summary.txt \
          --include-git-info

    - name: Compare with existing CLAUDE.md
      if: steps.analyze.outputs.changes_detected == 'true' || github.event.inputs.force_update == 'true'
      id: compare
      run: |
        if [ -f CLAUDE.md ] && [ -f CLAUDE.md.new ]; then
          if ! diff -q CLAUDE.md CLAUDE.md.new > /dev/null; then
            echo "claude_md_changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected in CLAUDE.md content"
          else
            echo "claude_md_changed=false" >> $GITHUB_OUTPUT
            echo "No changes in CLAUDE.md content"
          fi
        else
          echo "claude_md_changed=true" >> $GITHUB_OUTPUT
          echo "CLAUDE.md file missing or new file created"
        fi

    - name: Update CLAUDE.md
      if: steps.compare.outputs.claude_md_changed == 'true'
      run: |
        mv CLAUDE.md.new CLAUDE.md
        echo "CLAUDE.md updated with latest codebase changes"

    - name: Commit changes
      if: steps.compare.outputs.claude_md_changed == 'true' && github.event_name == 'push'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add CLAUDE.md
        git commit -m "🤖 Auto-update CLAUDE.md documentation

        Updated based on changes to:
        $(cat changes_summary.txt | head -10)
        
        Generated at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        Commit: ${{ github.sha }}
        " || exit 0

    - name: Push changes
      if: steps.compare.outputs.claude_md_changed == 'true' && github.event_name == 'push'
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}

    - name: Create Pull Request
      if: steps.compare.outputs.claude_md_changed == 'true' && github.event_name == 'pull_request'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          🤖 Auto-update CLAUDE.md documentation
          
          Updated based on codebase changes in PR #${{ github.event.number }}
        title: "🤖 Update CLAUDE.md documentation"
        body: |
          ## Automated CLAUDE.md Update
          
          This PR updates the CLAUDE.md file based on detected changes in the codebase.
          
          ### Changes Detected:
          ```
          $(cat changes_summary.txt)
          ```
          
          ### Files Analyzed:
          - sql_analyzer.py
          - Analyze-SqlCode.ps1
          - config.json
          - requirements.txt
          - SQL schema files
          - Examples and documentation
          
          ### Generated Information:
          - Updated command examples
          - Refreshed architecture overview
          - Current configuration options
          - Latest file structure
          
          **Note:** This is an automated update. Please review the changes before merging.
        branch: update-claude-md-${{ github.run_number }}
        delete-branch: true

    - name: Add PR comment with update summary
      if: steps.compare.outputs.claude_md_changed == 'true' && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const changesSummary = fs.readFileSync('changes_summary.txt', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## 🤖 CLAUDE.md Update Available
            
            I've detected changes that affect the CLAUDE.md documentation:
            
            \`\`\`
            ${changesSummary}
            \`\`\`
            
            A new PR will be created with the updated documentation once this PR is merged.`
          });

    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: claude-md-update-artifacts
        path: |
          changes_summary.txt
          CLAUDE.md.new
          CLAUDE.md
        retention-days: 30