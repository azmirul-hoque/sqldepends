# SQL Server Code Analysis Tool

A comprehensive tool for analyzing source code files to identify SQL Server database object references, ADO.NET usage patterns, and Entity Framework mappings. Generates detailed SQL views for database dependency analysis and documentation.

## Features

- **Multi-Language Support**: Analyzes C#, VB.NET, JavaScript, TypeScript, Python, and SQL files
- **ADO.NET Analysis**: Comprehensive SqlCommand, SqlDataAdapter, SqlConnection pattern detection
- **Entity Framework**: DbContext, DbSet, and raw SQL analysis
- **SQL Object Detection**: Tables, views, stored procedures, functions, parameters, and columns
- **Code Block Mapping**: Classes, methods, properties with precise line number tracking
- **Configuration Analysis**: Connection strings and SQL in config files
- **Performance Optimized**: Handles large codebases efficiently with progress reporting
- **Multiple Output Formats**: SQL views, CSV, JSON export options

## Prerequisites

### Python Version
- Python 3.8 or higher
- Required packages (see requirements.txt)

### PowerShell Version
- PowerShell 5.1 or PowerShell Core 7.0+
- .NET Framework 4.7.2+ (Windows PowerShell) or .NET Core (PowerShell Core)

## Installation

### Python Setup
```bash
# Clone or download the tool
git clone https://github.com/dbbuilder/sqldepends.git
cd sqldepends

# Install required packages
pip install -r requirements.txt

# Or using conda
conda env create -f environment.yml
conda activate sql-analysis
```

### PowerShell Setup
```powershell
# No additional installation required for basic functionality
# Optional: Install SqlServer module for enhanced SQL parsing
Install-Module -Name SqlServer -Force -AllowClobber
```

## Usage

### Python Version
```bash
# Basic usage
python sql_analyzer.py --directory "C:\MyProject" --output "analysis_results.sql"

# With advanced options
python sql_analyzer.py \
    --directory "C:\MyProject" \
    --output "analysis_results.sql" \
    --format json \
    --exclude-dirs "__pycache__,node_modules,.git" \
    --include-extensions ".cs,.vb,.js,.ts" \
    --connection-string "Server=localhost;Database=MyDB;Trusted_Connection=true" \
    --validate-objects
```

### PowerShell Version
```powershell
# Basic usage
.\Analyze-SqlCode.ps1 -Directory "C:\MyProject" -OutputPath "analysis_results.sql"

# With advanced options
.\Analyze-SqlCode.ps1 `
    -Directory "C:\MyProject" `
    -OutputPath "analysis_results.sql" `
    -ExcludeDirs @("bin", "obj", "packages") `
    -IncludeExtensions @(".cs", ".vb", ".sql") `
    -GenerateReport `
    -Verbose
```

## Configuration

### appsettings.json (Python)
```json
{
  "AnalysisSettings": {
    "SupportedExtensions": [".cs", ".vb", ".js", ".ts", ".py", ".sql"],
    "ExcludeDirectories": ["bin", "obj", "packages", "node_modules", ".git", ".vs"],
    "ExcludeFiles": ["*.designer.cs", "*.generated.cs", "*.g.cs"],
    "MaxFileSize": 104857600,
    "ParallelProcessing": true,
    "MaxDegreeOfParallelism": 4
  },
  "OutputSettings": {
    "DefaultFormat": "sql",
    "IncludeSourceSnippets": true,
    "MaxSnippetLength": 1000,
    "GenerateStatistics": true
  },
  "SqlAnalysis": {
    "DetectDynamicSql": true,
    "AnalyzeStringConcatenation": true,
    "ParseConfigurationFiles": true,
    "ValidateAgainstDatabase": false,
    "DefaultSchema": "dbo"
  },
  "Logging": {
    "LogLevel": "Information",
    "LogToFile": true,
    "LogPath": "logs/sql-analysis.log"
  }
}
```

## Output Formats

### SQL View (Default)
Generates a T-SQL CREATE VIEW statement that can be executed in SQL Server Management Studio:

```sql
-- Generated by SQL Server Code Analysis Tool
-- Analysis Date: 2025-01-15 10:30:00
-- Source Directory: C:\MyProject
-- Files Analyzed: 1,247

IF OBJECT_ID('vw_CodeAnalysis', 'V') IS NOT NULL
    DROP VIEW vw_CodeAnalysis

GO

CREATE VIEW vw_CodeAnalysis AS
SELECT 
    FilePath,
    FileName,
    FileExtension,
    CodeBlockType,
    -- ... additional columns
FROM (
    VALUES 
        ('C:\MyProject\Controllers\UserController.cs', 'UserController.cs', '.cs', 'Method', 'GetUser', 45, 'Table', 'dbo', 'Users', 'UserId', NULL, NULL, NULL, 'SELECT * FROM Users WHERE UserId = @userId', 'SqlCommand', 'CommandText', NULL, 'MyDatabase', 'Text', '2025-01-15 10:30:00', 'cmd.CommandText = "SELECT * FROM Users WHERE UserId = @userId"', 95, 'Direct SQL in method'),
        -- ... more rows
) AS Analysis(FilePath, FileName, FileExtension, CodeBlockType, CodeBlockName, LineNumber, SqlObjectType, SchemaName, ObjectName, ColumnName, ParameterName, ParameterType, ParameterDirection, SqlStatement, AdoNetObjectType, AdoNetProperty, ConnectionStringName, DatabaseName, CommandType, AnalysisTimestamp, SourceCodeSnippet, Confidence, Notes)
```

### JSON Format
```json
{
  "analysisMetadata": {
    "toolVersion": "1.0.0",
    "analysisDate": "2025-01-15T10:30:00Z",
    "sourceDirectory": "C:\\MyProject",
    "filesAnalyzed": 1247,
    "processingTimeMs": 45230
  },
  "results": [
    {
      "filePath": "C:\\MyProject\\Controllers\\UserController.cs",
      "fileName": "UserController.cs",
      "fileExtension": ".cs",
      "codeBlockType": "Method",
      "codeBlockName": "GetUser",
      "lineNumber": 45,
      "sqlObjectType": "Table",
      "schemaName": "dbo",
      "objectName": "Users",
      "columnName": "UserId",
      "sqlStatement": "SELECT * FROM Users WHERE UserId = @userId",
      "adoNetObjectType": "SqlCommand",
      "adoNetProperty": "CommandText",
      "confidence": 95,
      "sourceCodeSnippet": "cmd.CommandText = \"SELECT * FROM Users WHERE UserId = @userId\""
    }
  ],
  "statistics": {
    "totalSqlReferences": 1834,
    "uniqueTables": 45,
    "uniqueStoredProcedures": 23,
    "adoNetUsages": 156
  }
}
```

## Examples

### Analyzing a .NET Web Application
```bash
python sql_analyzer.py \
    --directory "C:\Projects\MyWebApp" \
    --output "webapp_analysis.sql" \
    --include-extensions ".cs,.cshtml,.js" \
    --exclude-dirs "bin,obj,wwwroot\lib"
```

### Analyzing Legacy VB.NET Application
```powershell
.\Analyze-SqlCode.ps1 `
    -Directory "C:\Legacy\VBApp" `
    -OutputPath "legacy_analysis.json" `
    -Format "JSON" `
    -IncludeExtensions @(".vb", ".aspx", ".ascx")
```

### Enterprise Analysis with Validation
```bash
python sql_analyzer.py \
    --directory "C:\Enterprise\Solutions" \
    --output "enterprise_analysis.sql" \
    --connection-string "Server=prod-sql;Database=Enterprise;Integrated Security=true" \
    --validate-objects \
    --parallel-processing \
    --generate-report
```

## Advanced Features

### Database Object Validation
When provided with a connection string, the tool can validate that referenced database objects actually exist:

```bash
python sql_analyzer.py \
    --directory "C:\MyProject" \
    --connection-string "Server=localhost;Database=MyDB;Trusted_Connection=true" \
    --validate-objects
```

### Custom Detection Rules
Create custom regex patterns for specialized SQL detection:

```json
{
  "CustomPatterns": [
    {
      "name": "CustomORM",
      "pattern": "\\bQuery<(\\w+)>\\(\"([^\"]+)\"\\)",
      "objectType": "CustomQuery",
      "groups": ["EntityType", "SqlStatement"]
    }
  ]
}
```

### Batch Processing
Process multiple projects simultaneously:

```bash
python sql_analyzer.py \
    --batch-file "project_list.txt" \
    --output-directory "analysis_results" \
    --parallel-processing
```

## Troubleshooting

### Common Issues

1. **Large File Processing**: For very large files, increase memory allocation or use streaming mode
2. **Access Denied**: Ensure the tool has read permissions for all target directories
3. **Encoding Issues**: Specify file encoding explicitly for non-UTF8 files
4. **Performance**: Use parallel processing and exclude unnecessary directories

### Debugging

Enable verbose logging:
```bash
python sql_analyzer.py --directory "C:\MyProject" --log-level DEBUG
```

View analysis statistics:
```bash
python sql_analyzer.py --directory "C:\MyProject" --generate-statistics
```

## Contributing

1. Fork the repository
2. Create a feature branch
3. Add tests for new functionality
4. Ensure all tests pass
5. Submit a pull request

## License

This project is licensed under the MIT License - see the LICENSE file for details.

## Support

For issues, questions, or contributions:
- Create an issue on GitHub
- Check the documentation in the `docs/` folder
- Review the troubleshooting guide
